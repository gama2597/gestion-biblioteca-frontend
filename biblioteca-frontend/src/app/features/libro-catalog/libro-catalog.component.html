<div class="app-container fadein animation-duration-500">
  <p-toast position="bottom-right"></p-toast>
  <p-confirmDialog [style]="{width: '450px'}" [breakpoints]="{'960px': '75vw', '640px': '95vw'}"></p-confirmDialog>

  <div class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title text-3xl md:text-5xl">
        <i class="pi pi-book mr-2"></i>Sistema de Gestión de Biblioteca
      </h1>
      <p class="hero-subtitle">Gestión inteligente de recursos bibliográficos</p>

      <div class="search-box shadow-4">
        <i class="pi pi-search text-500 text-xl"></i>
        <input type="text" pInputText placeholder="Buscar por título, autor o género..." [(ngModel)]="searchTerm"
          (input)="onSearch()" class="w-full border-none shadow-none text-lg">
      </div>
    </div>
  </div>

  <div class="main-content">

    <div
      class="actions-bar flex flex-column-reverse md:flex-row md:justify-content-between align-items-center mb-4 gap-3">

      <div class="flex gap-3 w-full md:w-auto justify-content-center md:justify-content-start">
        <div class="stat-card available shadow-2 flex-1 md:flex-none justify-content-center">
          <div class="icon-circle"><i class="pi pi-check"></i></div>
          <div class="flex flex-column">
            <span class="count">{{ getAvailableCount() }}</span>
            <span class="label">Disponibles</span>
          </div>
        </div>
        <div class="stat-card borrowed shadow-2 flex-1 md:flex-none justify-content-center">
          <div class="icon-circle"><i class="pi pi-clock"></i></div>
          <div class="flex flex-column">
            <span class="count">{{ getBorrowedCount() }}</span>
            <span class="label">Prestados</span>
          </div>
        </div>
      </div>

      <button pButton label="Nuevo Libro" icon="pi pi-plus"
        class="create-btn shadow-3 border-round-3xl px-4 w-full md:w-auto" (click)="openNew()">
      </button>
    </div>

    <div class="table-wrapper bg-white shadow-3 border-round-2xl overflow-hidden">
      <p-tabView (onChange)="onTabChange($event)" styleClass="custom-tabs">
        <p-tabPanel header="Todos"> <ng-container *ngTemplateOutlet="booksTable"></ng-container>
        </p-tabPanel>
        <p-tabPanel header="Disponibles">
          <ng-container *ngTemplateOutlet="booksTable"></ng-container>
        </p-tabPanel>
        <p-tabPanel header="Prestados">
          <ng-container *ngTemplateOutlet="booksTable"></ng-container>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>

  <ng-template #booksTable>
    <p-table [value]="libros" [rows]="5" [paginator]="true" [rowsPerPageOptions]="[5, 10, 20]"
      styleClass="p-datatable-striped" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th class="hidden md:table-cell" style="width: 15%">ISBN</th>
          <th style="width: 30%">INFORMACIÓN</th>
          <th class="hidden md:table-cell" style="width: 20%">AUTOR</th>
          <th style="width: 15%">ESTADO</th>
          <th style="width: 20%; text-align: right">ACCIONES</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-libro>
        <tr class="table-row">
          <td class="hidden md:table-cell"><span class="isbn-badge">{{ libro.isbn }}</span></td>
          <td>
            <div class="flex flex-column">
              <span class="font-bold text-900 text-lg">{{ libro.titulo }}</span>
              <span class="text-sm text-500 md:hidden">{{ libro.autor }}</span>
              <span class="text-sm text-500">{{ libro.genero }} • {{ libro.anioPublicacion }}</span>
            </div>
          </td>
          <td class="hidden md:table-cell font-medium text-700">{{ libro.autor }}</td>
          <td>
            <div class="status-badge" [ngClass]="libro.disponible ? 'status-success' : 'status-borrowed'">
              <i class="pi" [ngClass]="libro.disponible ? 'pi-check-circle' : 'pi-user'"></i>
              <span class="hidden md:inline ml-2">{{ libro.disponible ? 'Disponible' : 'Prestado' }}</span>
            </div>
          </td>
          <td style="text-align: right">
            <div class="flex justify-content-end gap-2">

              <button class="action-btn" [ngClass]="libro.disponible ? 'loan' : 'return'" (click)="toggleLoan(libro)"
                [pTooltip]="libro.disponible ? 'Prestar Libro' : 'Devolver Libro'" tooltipPosition="top">
                <i class="pi" [ngClass]="libro.disponible ? 'pi-arrow-right-arrow-left' : 'pi-check'"></i>
              </button>

              <button class="action-btn edit" (click)="editBook(libro)" pTooltip="Editar Libro" tooltipPosition="top">
                <i class="pi pi-pencil"></i>
              </button>

              <button class="action-btn delete" (click)="deleteBook(libro)" pTooltip="Eliminar Registro"
                tooltipPosition="top">
                <i class="pi pi-trash"></i>
              </button>

            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ng-template>

  <p-dialog [(visible)]="libroDialog" [style]="{width: '600px'}" [breakpoints]="{'960px': '75vw', '640px': '95vw'}"
    [header]="isEditing ? 'Editar Libro' : 'Nuevo Registro'" [modal]="true"
    styleClass="p-fluid custom-dialog border-round-xl">

    <ng-template pTemplate="content">
      <div class="flex flex-column gap-4 mt-3">

        <div class="field">
          <label class="font-bold">Título del Libro *</label>
          <input pInputText [(ngModel)]="libroActual.titulo" class="custom-input" maxlength="200" required
            placeholder="Ej: Cien años de soledad" />
          <div class="flex justify-content-between mt-1">
            <small class="p-error block" *ngIf="!libroActual.titulo && isSubmitted">Requerido</small>
            <small class="text-500 text-xs ml-auto">{{ libroActual.titulo?.length || 0 }} / 200</small>
          </div>
        </div>

        <div class="formgrid grid">
          <div class="field col-12 md:col-8">
            <label class="font-bold">Autor *</label>
            <input pInputText [(ngModel)]="libroActual.autor" class="custom-input" maxlength="100" required
              placeholder="Ej: Gabriel García Márquez" />
            <div class="flex justify-content-between mt-1">
              <small class="p-error block" *ngIf="!libroActual.autor && isSubmitted">Requerido</small>
              <small class="text-500 text-xs ml-auto">{{ libroActual.autor?.length || 0 }} / 100</small>
            </div>
          </div>
          <div class="field col-12 md:col-4">
            <label class="font-bold">Año *</label>
            <input pInputText type="number" [(ngModel)]="libroActual.anioPublicacion" class="custom-input" min="1000"
              max="2025" />
            <small class="p-error block mt-1" *ngIf="!libroActual.anioPublicacion && isSubmitted">Requerido</small>
          </div>
        </div>

        <div class="formgrid grid">
          <div class="field col-12 md:col-6">
            <label class="font-bold">ISBN *</label>
            <input pInputText [(ngModel)]="libroActual.isbn" class="custom-input" maxlength="30"
              placeholder="ISBN-XXX-X..." />
            <div class="flex justify-content-between mt-1">
              <small class="p-error block" *ngIf="!libroActual.isbn && isSubmitted">Requerido</small>
              <small class="text-500 text-xs ml-auto">{{ libroActual.isbn?.length || 0 }} / 30</small>
            </div>
          </div>
          <div class="field col-12 md:col-6">
            <label class="font-bold">Género *</label>
            <input pInputText [(ngModel)]="libroActual.genero" class="custom-input" maxlength="50"
              placeholder="Ej: Novela" />
            <div class="flex justify-content-between mt-1">
              <small class="p-error block" *ngIf="!libroActual.genero && isSubmitted">Requerido</small>
              <small class="text-500 text-xs ml-auto">{{ libroActual.genero?.length || 0 }} / 50</small>
            </div>
          </div>
        </div>

        <div class="field-checkbox p-3 surface-100 border-round flex align-items-center gap-2 cursor-pointer"
          (click)="disp.click()">
          <p-checkbox [(ngModel)]="libroActual.disponible" [binary]="true" inputId="disp" #disp></p-checkbox>
          <label for="disp" class="font-medium cursor-pointer flex-1">Disponible para préstamo inmediato</label>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2 mt-2">
        <button pButton label="Cancelar" class="p-button-text text-500" (click)="libroDialog = false"></button>
        <button pButton label="Guardar Registro" class="p-button-primary border-round-lg px-4"
          (click)="saveBook()"></button>
      </div>
    </ng-template>
  </p-dialog>
</div>
